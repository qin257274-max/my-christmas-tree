<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ¢¦å¹»åœ£è¯å®‡å®™ - å…±åŒåˆ›é€ ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&family=Long+Cang&family=Noto+Serif+SC:wght@200;400;600&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #010206; font-family: 'Noto Serif SC', serif; color: white; }
        #canvas-container { width: 100vw; height: 100vh; display: block; }
        
        #video-container {
            position: absolute; top: 20px; right: 20px;
            width: 160px; height: 120px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 15px; overflow: hidden; background: #000; z-index: 100;
        }
        #webcam { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .ui-overlay { position: absolute; top: 30px; left: 30px; pointer-events: none; z-index: 10; }
        .ui-overlay h1 {
            margin: 0; font-size: 38px; font-weight: 200; letter-spacing: 6px;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
            font-family: 'Zhi Mang Xing', cursive;
        }
        .status-tag {
            background: rgba(255, 255, 255, 0.03); padding: 8px 22px; border-radius: 30px;
            font-size: 18px; border: 1px solid rgba(255, 255, 255, 0.2); display: inline-block; margin-top: 15px;
            letter-spacing: 3px; font-family: 'Long Cang', cursive; min-width: 240px; transition: all 0.8s;
        }

        #action-panel { position: absolute; top: 140px; left: 30px; z-index: 20; display: flex; flex-direction: column; gap: 15px; }
        .music-btn, .msg-btn {
            background: rgba(255, 255, 255, 0.1); color: #ffffff; border: 1px solid rgba(255,255,255,0.4);
            padding: 10px 28px; border-radius: 30px; cursor: pointer; font-size: 15px;
            transition: all 0.4s; letter-spacing: 4px; backdrop-filter: blur(10px); font-family: 'Long Cang', cursive;
        }
        .music-btn:hover, .msg-btn:hover { background: rgba(255, 255, 255, 0.9); color: #010206; transform: scale(1.05); }

        #msg-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.8);
            width: 380px; background: rgba(10, 10, 25, 0.98); border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 30px; padding: 35px; text-align: center; opacity: 0; visibility: hidden;
            transition: all 0.5s cubic-bezier(0.19, 1, 0.22, 1); z-index: 300;
        }
        #msg-modal.active { transform: translate(-50%, -50%) scale(1); opacity: 1; visibility: visible; }
        #msg-input {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 15px; color: white; padding: 15px; font-size: 16px; margin: 20px 0;
            font-family: 'Noto Serif SC', serif; outline: none; box-sizing: border-box;
        }
        .submit-btn {
            background: #ffffff; color: #010206; border: none; padding: 10px 40px; border-radius: 20px;
            font-family: 'Long Cang', cursive; cursor: pointer; font-size: 18px;
        }

        #gift-modal {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.3);
            width: 480px; background: rgba(5, 5, 12, 0.96); border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 40px; padding: 50px; text-align: center; opacity: 0; visibility: hidden;
            transition: all 0.8s cubic-bezier(0.19, 1, 0.22, 1); z-index: 200; backdrop-filter: blur(25px);
        }
        #gift-modal.active { transform: translate(-50%, -50%) scale(1); opacity: 1; visibility: visible; }
        #gift-emoji { font-size: 90px; margin-bottom: 20px; display: block; filter: drop-shadow(0 0 20px rgba(255,255,255,0.5)); }
        #gift-text { line-height: 2.2; color: #ffffff; font-size: 20px; font-family: 'Noto Serif SC', serif; text-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }

        #cursor {
            position: fixed; width: 32px; height: 32px; border: 1px solid white;
            border-radius: 50%; pointer-events: none; z-index: 999; display: none;
            box-shadow: 0 0 25px rgba(255,255,255,0.8); transition: transform 0.1s;
        }
        .cursor-pinching { border-color: #ffd700; transform: scale(0.7); border-width: 4px; box-shadow: 0 0 40px #ffd700; }
        .cursor-success { background: rgba(255,215,0,0.4); transform: scale(1.8); }
    </style>
</head>
<body>

    <div class="ui-overlay">
        <h1>æ¬¢è¿æ¥åˆ°æˆ‘çš„åœ£è¯å®‡å®™</h1>
        <div id="ai-status" class="status-tag">æ˜Ÿé™…é“¾è·¯åˆå§‹åŒ–ä¸­...</div>
    </div>

    <div id="action-panel">
        <button id="start-audio" class="music-btn">ç‚¹å‡»å¼€å¯å®‡å®™æ—‹å¾‹</button>
        <button id="open-msg" class="msg-btn">æŠ•é€’å®‡å®™ç”µæ³¢</button>
    </div>

    <div id="video-container"><video id="webcam" autoplay playsinline></video></div>
    <div id="cursor"></div>

    <div id="msg-modal">
        <h2 style="font-family: 'Long Cang'; font-weight: 200; letter-spacing: 2px;">æŠ•é€’ä½ çš„æ˜Ÿé™…ç•™è¨€</h2>
        <textarea id="msg-input" placeholder="ç•™ä¸‹ä¸€å¥æƒ³å¯¹è‡ªå·±æˆ–ä¸–ç•Œè¯´çš„è¯..." rows="3"></textarea>
        <button id="submit-msg" class="submit-btn">å‘å°„åˆ°é“¶æ²³</button>
    </div>

    <div id="gift-modal">
        <div id="gift-emoji">âœ¨</div>
        <div id="gift-text"></div>
        <div style="font-size: 13px; color: #ffffff; margin-top: 40px; letter-spacing: 3px; opacity: 0.4; font-family: 'Long Cang';">å†æ¬¡æåˆåŒæŒ‡æ”¾å›ç¤¼ç‰©</div>
    </div>

    <div id="canvas-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script type="module">
        import * as THREE from "https://cdn.skypack.dev/three@0.128.0";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // é…ç½®é€»è¾‘
        let firebaseConfig;
        try { firebaseConfig = JSON.parse(__firebase_config); } 
        catch (e) { firebaseConfig = { apiKey: "PLACEHOLDER", authDomain: "PLACEHOLDER", projectId: "PLACEHOLDER", storageBucket: "PLACEHOLDER", messagingSenderId: "PLACEHOLDER", appId: "PLACEHOLDER" }; }

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'shared-xmas-universe';

        const baseGifts = [
            { emoji: "ğŸŒ±", message: "å³ä¾¿æ·±é™·æ³¥æ³ï¼Œä¹Ÿä»æœªçœŸæ­£ç†„ç­è¿‡çš„è‡ªæˆ‘æ„ˆåˆåŠ›ã€‚" },
            { emoji: "ğŸ•¯ï¸", message: "åœ¨å˜ˆæ‚çº·ç¹çš„ä¸–ç•Œé‡Œï¼Œä¾ç„¶èƒ½å¬è§å†…å¿ƒå¾®å¼±å´æ¸…æ¾ˆçš„å£°éŸ³ã€‚" },
            { emoji: "ğŸ‚", message: "å…è®¸æ‰€æœ‰ä¸å¦‚æ„çš„äº‹æƒ…å‘ç”Ÿï¼Œå¹¶èƒ½è½»æ‹å°˜åœŸç»§ç»­å‰è¡Œçš„æ·¡ç„¶ã€‚" },
            { emoji: "â˜•", message: "åœ¨å¹³æ·¡å¦‚æ°´çš„æ—¥å¸¸é‡Œï¼Œä¾ç„¶èƒ½æ•é”æ•æ‰åˆ°å¾®å°ç¾å¥½çš„æ„ŸçŸ¥åŠ›ã€‚" },
            { emoji: "ğŸŒ‘", message: "åœ¨æ— äººçŸ¥æ™“çš„ä½è°·ï¼Œèƒ½ç»™äºˆè‡ªå·±ä¸€ä¸ªæ¸©æš–æ‹¥æŠ±çš„æ…ˆæ‚²ã€‚" },
            { emoji: "ğŸŒŠ", message: "é¢å¯¹ä¸å¯é¿å…çš„æ”¹å˜ï¼Œå´èƒ½é¡ºæµè€Œä¸‹ã€è½»ç›ˆèµ·èˆçš„æŸ”éŸ§ã€‚" },
            { emoji: "ğŸ’", message: "å³ä¾¿å—è¿‡ä¼¤å®³ï¼Œä¾ç„¶æ‹¥æœ‰é‚£ç§é€‰æ‹©å»ä¿¡ä»»ä¸å–„è‰¯çš„æœ¬èƒ½ã€‚" },
            { emoji: "ğŸ•°ï¸", message: "ä¸è¢«ä»–äººçš„è¿›åº¦æ¡æ‰€å¹²æ‰°ï¼Œåšå®šå®ˆä½è‡ªå·±èŠ‚å¾‹çš„ä»å®¹ã€‚" },
            { emoji: "ğŸ§˜", message: "åœ¨æè‡´çš„å­¤ç‹¬ä¸­ï¼Œèƒ½ç”Ÿå‘å‡ºä¸€é¢—è‡ªç»™è‡ªè¶³ã€æ°¸ä¸è’èŠœçš„å†…å¿ƒã€‚" },
            { emoji: "ğŸ­", message: "èƒ½æ´å¯Ÿä»–äººçš„éšå¿ä¸è‹¦è¡·ï¼Œå¹¶ç»™äºˆæ°åˆ°å¥½å¤„æ²‰é»˜çš„æ…ˆæ‚²ã€‚" },
            { emoji: "ğŸ¨", message: "åšæŒæŠŠæ¯ä¸€ä»¶â€˜æ— ç”¨â€™å´å¾®å°çš„äº‹ï¼Œåšå¾—è¯—æ„ç›ç„¶çš„çº¯ç²¹ã€‚" },
            { emoji: "ğŸ”­", message: "å¯¹ç”Ÿå‘½æœ¬èº«æ°¸è¿œæ€€æœ‰èµ¤è¯šï¼Œåƒä»æœªå—è¿‡ä¼¤ä¸€æ ·å»æ¢ç´¢çš„çƒ­å¿±ã€‚" }
        ];

        let scene, camera, renderer, clock, mainGroup;
        let instancedTreeCubes, instancedTreeIcos, instancedBaseCubes, instancedBaseIcos, giftBoxes = [], hitTargets = [];
        let treeOriginalData = [], baseOriginalData = [];
        let targetRotationY = 0, isModalOpen = false, audioCtx = null, currentSelectedGift = null;
        let raycaster = new THREE.Raycaster(), mouse = new THREE.Vector2();
        
        let isScattered = false, scatterLerp = 0, isPinchingGift = false;
        let rotationTraveled = 0, lastToneTime = 0, noteIndex = 0, snowActive = false, snowTimer = 0, snowParticles, snowMaterial;
        let ambientParticles, topStar, currentUser = null;

        const MELODY = [261.63, 349.23, 349.23, 392.00, 349.23, 329.63, 293.66, 293.66, 293.66, 392.00, 392.00, 440.00, 392.00, 349.23, 329.63, 261.63, 261.63, 440.00, 440.00, 466.16, 440.00, 392.00, 349.23, 293.66, 261.63, 261.63, 293.66, 392.00, 329.63, 349.23];

        window.onload = async () => {
            initThree();
            baseGifts.forEach((data, i) => addGiftToScene(data, i));
            const signInWithRetry = async (retries = 3) => {
                for (let i = 0; i < retries; i++) {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) return await signInWithCustomToken(auth, __initial_auth_token);
                        else return await signInAnonymously(auth);
                    } catch (err) { if (i === retries - 1) throw err; }
                }
            };
            try {
                const cred = await signInWithRetry(); currentUser = cred.user;
                document.getElementById('ai-status').innerText = "è½»æŒ¥æ‰‹éƒ¨ï¼Œå¼€å¯æ¢ç´¢...";
                listenForCloudGifts();
            } catch (e) { document.getElementById('ai-status').innerText = "å®‡å®™ä¿¡å·è¾ƒå¼±ï¼Œè¯·åˆ·æ–°é‡è¯•"; }
            initAI();
            initUIListeners();
            animate();
        };

        function listenForCloudGifts() {
            if (!currentUser) return;
            const giftsCol = collection(db, 'artifacts', appId, 'public', 'data', 'userGifts');
            onSnapshot(giftsCol, (snap) => {
                snap.docChanges().forEach((change) => {
                    if (change.type === "added") addGiftToScene(change.doc.data(), giftBoxes.length);
                });
            }, (err) => console.error("Firestore error", err));
        }

        function addGiftToScene(data, index) {
            const group = new THREE.Group();
            const color = new THREE.Color().setHSL(Math.random(), 0.7, 0.6);
            const box = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1.5, 1.5), new THREE.MeshStandardMaterial({ color: color, emissive: color, emissiveIntensity: 0.7, metalness: 0.7, roughness: 0.2 }));
            group.add(box); group.add(new THREE.Mesh(new THREE.BoxGeometry(1.6, 0.1, 1.6), new THREE.MeshBasicMaterial({ color: '#ffffff' })));
            const hitTarget = new THREE.Mesh(new THREE.SphereGeometry(3.5, 8, 8), new THREE.MeshBasicMaterial({ visible: false }));
            hitTarget.userData.parentGroup = group; group.add(hitTarget); hitTargets.push(hitTarget);
            const yMin = -5.5, yMax = 14.5; let y = yMin + (index * 1.2); if (y > yMax) y = yMax - (index % 5);
            const radius = 9.5 * (1 - (y + 5.5) / 24) * 0.85; const angle = index * 2.399;
            group.position.set(Math.cos(angle) * radius, y, Math.sin(angle) * radius);
            group.userData = { msgData: data, dist: Math.sqrt(group.position.x**2+group.position.z**2), angle: Math.atan2(group.position.z, group.position.x), baseY: y, isHighlighted: false };
            giftBoxes.push(group); mainGroup.add(group);
        }

        function initUIListeners() {
            const modal = document.getElementById('msg-modal'), input = document.getElementById('msg-input');
            document.getElementById('open-msg').onclick = () => modal.classList.add('active');
            document.getElementById('submit-msg').onclick = async () => {
                if (!currentUser || !input.value.trim()) return;
                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'userGifts'), { message: input.value, emoji: "âœ¨", timestamp: serverTimestamp() });
                    input.value = ""; modal.classList.remove('active');
                } catch(e) {}
            };
            document.getElementById('start-audio').onclick = () => {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                document.getElementById('start-audio').style.display = 'none';
            };
        }

        function initThree() {
            scene = new THREE.Scene(); scene.fog = new THREE.FogExp2(0x010206, 0.005);
            camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 2000); camera.position.set(0, 10, 65);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio); document.getElementById('canvas-container').appendChild(renderer.domElement);
            clock = new THREE.Clock(); mainGroup = new THREE.Group(); scene.add(mainGroup);
            createTree(); createBase(); createSnow(); createCosmicAmbient(); createTechStar();
            scene.add(new THREE.HemisphereLight(0xffffff, 0x010206, 3.0));
            const plight = new THREE.PointLight(0xffffff, 2, 80); plight.position.set(5, 20, 20); scene.add(plight);
        }

        function createCircleTexture() {
            const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64;
            const ctx = canvas.getContext('2d'); const grad = ctx.createRadialGradient(32, 32, 0, 32, 32, 32);
            grad.addColorStop(0, 'rgba(255,255,255,1)'); grad.addColorStop(0.5, 'rgba(255,255,255,0.2)'); grad.addColorStop(1, 'rgba(255,255,255,0)');
            ctx.fillStyle = grad; ctx.fillRect(0, 0, 64, 64); return new THREE.CanvasTexture(canvas);
        }

        function createCosmicAmbient() {
            const geo = new THREE.BufferGeometry(), pos = new Float32Array(50000*3);
            for (let i=0; i<50000; i++) {
                const r = 30+Math.random()*150, a = Math.random()*Math.PI*2, b = Math.random()*Math.PI;
                pos[i*3] = r*Math.sin(b)*Math.cos(a); pos[i*3+1] = r*Math.sin(b)*Math.sin(a); pos[i*3+2] = r*Math.cos(b);
            }
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            ambientParticles = new THREE.Points(geo, new THREE.PointsMaterial({ size: 0.3, color: 0xccccff, map: createCircleTexture(), transparent: true, opacity: 0.6, blending: THREE.AdditiveBlending, depthWrite: false }));
            scene.add(ambientParticles);
        }

        function createTechStar() {
            const shape = new THREE.Shape(); const outerRad = 1.6, innerRad = 0.7;
            for (let i = 0; i < 10; i++) {
                const r = i % 2 === 0 ? outerRad : innerRad; const a = (i / 10) * Math.PI * 2;
                const x = Math.cos(a - Math.PI / 2) * r, y = Math.sin(a - Math.PI / 2) * r;
                if (i === 0) shape.moveTo(x, y); else shape.lineTo(x, y);
            }
            shape.closePath(); topStar = new THREE.Mesh(new THREE.ExtrudeGeometry(shape, { depth: 0.1, bevelEnabled: false }), new THREE.MeshBasicMaterial({ color: '#ffffff' }));
            topStar.position.set(0, 18.5, 0); mainGroup.add(topStar);
        }

        function createTree() {
            const mat = new THREE.MeshPhysicalMaterial({ color: 0xfafaff, metalness: 0.9, roughness: 0.1, emissive: 0x9370db, emissiveIntensity: 0.5, transparent: true, opacity: 0.8 });
            instancedTreeCubes = new THREE.InstancedMesh(new THREE.BoxGeometry(0.12,0.12,0.12), mat, 12000);
            instancedTreeIcos = new THREE.InstancedMesh(new THREE.IcosahedronGeometry(0.12, 0), mat, 12000);
            const dummy = new THREE.Object3D(); let idx = 0;
            [{r:8.8,h:5.5,y:-2},{r:7.5,h:4.8,y:1.8},{r:6,h:4.2,y:5},{r:4.5,h:3.8,y:7.8},{r:3,h:3.2,y:10.2},{r:1.4,h:2.5,y:12.2}].forEach(l => {
                for(let i=0; i<2000; i++){
                    const h = Math.random(), r = (1-h)*l.r*(0.35+0.65*Math.sqrt(Math.random())), a = Math.random()*Math.PI*2;
                    dummy.position.set(Math.cos(a)*r, h*l.h+l.y, Math.sin(a)*r); dummy.rotation.set(Math.random()*Math.PI, 0, 0); dummy.updateMatrix();
                    instancedTreeCubes.setMatrixAt(idx, dummy.matrix); instancedTreeIcos.setMatrixAt(idx, dummy.matrix);
                    treeOriginalData.push({pos: dummy.position.clone(), rot: dummy.rotation.clone(), dir: dummy.position.clone().normalize().add(new THREE.Vector3(0,0.5,0)).normalize()});
                    idx++;
                }
            });
            mainGroup.add(instancedTreeCubes); mainGroup.add(instancedTreeIcos);
        }

        function createBase() {
            const mat = new THREE.MeshPhysicalMaterial({ color: 0xffffff, metalness: 0.8, roughness: 0.1, emissive: 0xffffff, emissiveIntensity: 0.2, transparent: true, opacity: 0.9 });
            instancedBaseCubes = new THREE.InstancedMesh(new THREE.BoxGeometry(0.15,0.15,0.15), mat, 7000);
            instancedBaseIcos = new THREE.InstancedMesh(new THREE.IcosahedronGeometry(0.15, 0), mat, 7000);
            const dummy = new THREE.Object3D();
            for(let i=0; i<7000; i++){
                const a = Math.random()*Math.PI*2, r = Math.sqrt(Math.random())*11.5;
                dummy.position.set(Math.cos(a)*r, -6, Math.sin(a)*r); dummy.updateMatrix();
                instancedBaseCubes.setMatrixAt(i, dummy.matrix); instancedBaseIcos.setMatrixAt(i, dummy.matrix);
                baseOriginalData.push({pos: dummy.position.clone(), r: r, angle: a});
            }
            mainGroup.add(instancedBaseCubes); mainGroup.add(instancedBaseIcos);
            const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.8, 1.1, 4.5, 24), new THREE.MeshStandardMaterial({ color: 0x111111 }));
            trunk.position.y = -3.8; mainGroup.add(trunk);
        }

        function createSnow() {
            const geo = new THREE.BufferGeometry(), pos = new Float32Array(2000 * 3);
            for(let i=0; i<2000; i++) { pos[i*3]=(Math.random()-0.5)*100; pos[i*3+1]=40+Math.random()*40; pos[i*3+2]=(Math.random()-0.5)*50; }
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            snowMaterial = new THREE.PointsMaterial({ size: 0.4, color: '#ffffff', map: createCircleTexture(), transparent: true, opacity: 0, blending: THREE.AdditiveBlending });
            snowParticles = new THREE.Points(geo, snowMaterial); scene.add(snowParticles);
        }

        async function initAI() {
            const hands = new window.Hands({ locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
            hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.75, minTrackingConfidence: 0.75 });
            let prevX = [0.5, 0.5];
            hands.onResults((res) => {
                if (res.multiHandLandmarks && res.multiHandLandmarks.length > 0) {
                    window.lastDetectionTime = Date.now();
                    const primary = res.multiHandLandmarks[0];
                    const cursor = document.getElementById('cursor'), statusTag = document.getElementById('ai-status');
                    cursor.style.display = "block"; cursor.style.left = `${(1 - primary[8].x) * 100}vw`; cursor.style.top = `${primary[8].y * 100}vh`;
                    targetRotationY = (primary[8].x - 0.5) * Math.PI * 4;

                    // æŒ‡ä»¤è¯†åˆ«åˆ¤æ–­
                    const pinching = Math.sqrt((primary[8].x-primary[4].x)**2 + (primary[8].y-primary[4].y)**2) < 0.045;
                    const extFingers = [8,12,16,20].filter(i => primary[i].y < primary[0].y - 0.05).length;

                    // --- æ ¸å¿ƒæ‰‹åŠ¿é€»è¾‘å¯¹é½ ---
                    
                    // é€»è¾‘ A: å¼¹çª—å·²å¼€å¯æ—¶çš„äº¤äº’
                    if (isModalOpen) {
                        if (pinching) {
                            // 5. æ”¾å›ç¤¼ç‰©
                            closeModal();
                            statusTag.innerText = "ğŸŒ€ ç¥ç¦å·²æ”¾å›å®‡å®™";
                        }
                    } 
                    // é€»è¾‘ B: å¼¹çª—å…³é—­æ—¶çš„äº¤äº’
                    else {
                        // 1/2. æ ‘ä½“å½¢æ€æ§åˆ¶ (ä»…åœ¨ä¸æ“ä½œç¤¼ç‰©ç›’æ—¶æœ‰æ•ˆ)
                        if (!isPinchingGift) {
                            if (extFingers >= 4) { isScattered = true; statusTag.innerText = "âœ¨ æ‰‹æŒå¼ å¼€ï¼šæ˜Ÿé™…æ•£å¼€"; }
                            else if (extFingers === 0) { isScattered = false; statusTag.innerText = "ğŸŒŒ æ‰‹æŒæåˆï¼šæ ‘ä½“å‡èš"; }
                        }

                        // 3. é€‰å–ç¤¼ç‰©ç›’ (åŒæŒ‡æä½)
                        if (pinching) {
                            isPinchingGift = true;
                            cursor.classList.add('cursor-pinching');
                            handleSelectionUpdate(1 - primary[8].x, primary[8].y);
                            if (currentSelectedGift) statusTag.innerText = "ğŸ”’ æä½ï¼šå·²é€‰å–ç¤¼ç‰©";
                        } 
                        // 4. é€‰ä¸­å¼€å¯ (åŒæŒ‡å¼ å¼€)
                        else if (isPinchingGift) {
                            if (currentSelectedGift) {
                                openGiftModal(currentSelectedGift.userData);
                                cursor.classList.add('cursor-success');
                                setTimeout(() => cursor.classList.remove('cursor-success'), 600);
                                statusTag.innerText = "ğŸ å¼ å¼€ï¼šé€‰ä¸­å¼€å¯";
                            }
                            isPinchingGift = false;
                            cursor.classList.remove('cursor-pinching');
                        }
                    }

                    // 6. åŒæ‰‹æŒ¥åŠ¨å¬å”¤ä¸‹é›ª
                    if (res.multiHandLandmarks.length === 2) {
                        const moveDist = Math.abs(res.multiHandLandmarks[0][8].x - prevX[0]) + Math.abs(res.multiHandLandmarks[1][8].x - prevX[1]);
                        if (moveDist > 0.08) { snowActive = true; snowTimer = 240; statusTag.innerText = "â„ï¸ åŒæ‰‹æŒ¥åŠ¨ï¼šé™é›ªå¬å”¤"; }
                        prevX[0] = res.multiHandLandmarks[0][8].x; prevX[1] = res.multiHandLandmarks[1][8].x;
                    }
                } else { document.getElementById('cursor').style.display = "none"; }
            });
            const cam = new window.Camera(document.getElementById('webcam'), { onFrame: async () => await hands.send({ image: document.getElementById('webcam') }), width: 640, height: 480 });
            cam.start();
        }

        function handleSelectionUpdate(x, y) {
            mouse.x = x * 2 - 1; mouse.y = -y * 2 + 1; raycaster.setFromCamera(mouse, camera);
            const hits = raycaster.intersectObjects(hitTargets, false);
            if (hits.length > 0) {
                const sel = hits[0].object.userData.parentGroup;
                if (currentSelectedGift !== sel) { if(currentSelectedGift) currentSelectedGift.userData.isHighlighted = false; currentSelectedGift = sel; currentSelectedGift.userData.isHighlighted = true; }
            }
        }

        function openGiftModal(userData) {
            isModalOpen = true; const modal = document.getElementById('gift-modal');
            modal.classList.add('active'); document.getElementById('gift-emoji').innerText = userData.msgData.emoji || "âœ¨";
            const txt = document.getElementById('gift-text'); txt.innerText = userData.msgData.message;
        }

        function closeModal() { isModalOpen = false; document.getElementById('gift-modal').classList.remove('active'); if(currentSelectedGift) currentSelectedGift.userData.isHighlighted = false; }

        function animate() {
            requestAnimationFrame(animate); const t = clock.getElapsedTime();
            mainGroup.rotation.y += (targetRotationY - mainGroup.rotation.y) * 0.08;
            scatterLerp = THREE.MathUtils.lerp(scatterLerp, isScattered ? 1 : 0, 0.08);
            if (ambientParticles) ambientParticles.rotation.y += 0.0003;
            if (topStar) topStar.rotation.y += 0.03;
            const dummy = new THREE.Object3D();
            for(let i=0; i<treeOriginalData.length; i++) {
                const d = treeOriginalData[i]; dummy.position.copy(d.pos).addScaledVector(d.dir, 70*scatterLerp);
                dummy.rotation.set(d.rot.x+t*scatterLerp, d.rot.y+t*scatterLerp, d.rot.z); dummy.updateMatrix(); 
                instancedTreeCubes.setMatrixAt(i, dummy.matrix); instancedTreeIcos.setMatrixAt(i, dummy.matrix);
            }
            instancedTreeCubes.instanceMatrix.needsUpdate = true; instancedTreeIcos.instanceMatrix.needsUpdate = true;
            for(let i=0; i<baseOriginalData.length; i++) {
                const d = baseOriginalData[i], r = d.r*(1+scatterLerp*6);
                dummy.position.set(Math.cos(d.angle)*r, d.pos.y+Math.sin(d.r*0.4-t*2.5)*0.5*(1-scatterLerp), Math.sin(d.angle)*r);
                dummy.rotation.set(0, d.angle+t, 0); dummy.updateMatrix(); 
                instancedBaseCubes.setMatrixAt(i, dummy.matrix); instancedBaseIcos.setMatrixAt(i, dummy.matrix);
            }
            instancedBaseCubes.instanceMatrix.needsUpdate = true; instancedBaseIcos.instanceMatrix.needsUpdate = true;
            if(snowParticles) {
                snowMaterial.opacity = THREE.MathUtils.lerp(snowMaterial.opacity, (snowActive || snowTimer > 0) ? 0.8 : 0, 0.05);
                if(snowTimer > 0) snowTimer--; else snowActive = false;
                const pos = snowParticles.geometry.attributes.position.array;
                for(let i=0; i<2000; i++) { pos[i*3+1]-=0.15; if(pos[i*3+1]<-15) pos[i*3+1]=40; }
                snowParticles.geometry.attributes.position.needsUpdate = true;
            }
            giftBoxes.forEach((g) => {
                const d = g.userData; const scatter = 1+scatterLerp*5;
                g.position.x = THREE.MathUtils.lerp(g.position.x, Math.cos(d.angle)*d.dist*scatter, 0.1);
                g.position.z = THREE.MathUtils.lerp(g.position.z, Math.sin(d.angle)*d.dist*scatter, 0.1);
                g.scale.lerp(new THREE.Vector3(d.isHighlighted ? 1.8 : 1, d.isHighlighted ? 1.8 : 1, d.isHighlighted ? 1.8 : 1), 0.1);
                if (d.isHighlighted) g.children[0].material.emissiveIntensity = 2.0 + Math.sin(t*10);
            });
            // éŸ³ä¹è§¦å‘
            rotationTraveled += Math.abs(targetRotationY / 100);
            if (rotationTraveled > 0.15 && audioCtx && audioCtx.currentTime - lastToneTime > 0.1) {
                const osc = audioCtx.createOscillator(), gain = audioCtx.createGain();
                osc.type = 'triangle'; osc.frequency.setValueAtTime(MELODY[noteIndex], audioCtx.currentTime);
                gain.gain.setValueAtTime(0.08, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+1.0);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime+1.0);
                noteIndex = (noteIndex + 1) % MELODY.length; lastToneTime = audioCtx.currentTime; rotationTraveled = 0;
            }
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>